<html>
<head>
  <style>
  path {
    stroke:white;
    stroke-width: 0.5px;
    fill:#EBEBE0;
  }

  #float-button-group {
    position:fixed;
    left:10;
    opacity:0.5;
  }

  #float-button-group:hover {
    opacity:1;
  }

  #bigsvg {
    width: 1000px;
    height: 505px;
  }

  #map {
    background: #edfafc;
    width: 900px;
    height: 505px;
    border: 3px solid steelblue;
  }

  #map-zoomer {
    position:absolute;
    writing-mode: bt-lr;
    -webkit-appearance: slider-vertical;
    width: 8px;
    height: 100px;
    padding: 0 5px;
    position: absolute;
    top:110px;
    left:22px;
  }

  #label {
    font-size:8
  }
  </style>
</head>
<body>
  <div id="bigsvg">
    <div id="map">
    <div class="btn-group-vertical" role="group" aria-label="..." id="float-button-group">
      <button type="button" class="btn btn-default" id="zoom-in" name="in"><span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></span></button>
      <button type="button" class="btn btn-default" id="zoom-out" name="out"><span class="glyphicon glyphicon-zoom-out" aria-hidden="true"></span></button>
      <button type="button" class="btn btn-default" id="reset" name="reset"><span class="glyphicon glyphicon-screenshot" aria-hidden="true"></span></button>
    </div></div>
    <!--input type="range" value="1" min="1" max="8" orient="vertical" id="map-zoomer"/-->
  </div>
  <div class="btn-group-horizontal" role="group"><table><tr>
  <td><input type="checkbox" class="checkbox" value="Vulnerable" checked id="checkV"><label><font color="#8ad08a">Vulnerable</font></label></td>
    <td><input type="checkbox" class="checkbox" value="Definitely endangered" checked id="checkDE"><label><font color="#c5b7d9">Definitely endangered</font></label></td>
    <td><input type="checkbox" class="checkbox" value="Severely endangered" checked id="checkCE"><label><font color="#eaf202">Severely endangered</font></label></td>
    <td><input type="checkbox" class="checkbox" value="Critically endangered" checked id="checkCE"><label><font color="#f2020e">Critically endangered</font></label></td>
    <td><input type="checkbox" class="checkbox" value="Extinct" checked id="checkE"><label><font color="#000000">Extinct</font></label></td>
    <td>  <label for="nVel">
      Max # of Speakers = <span id="goal-value">8000000</span></td><td>
      <input style="width: 200px;" type="range" min="0" max="8000000" id="goal" value="8000000" step='100'>
    </label></td>
  </tr></table>
  </div>

  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://unpkg.com/topojson@3"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js" integrity="sha256-qo76Vs9B6JAALbrTn+PcN1r09hbNLd2M78V19glOMeU=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
  <script>
  //var width = d3.select('#map').node().getBoundingClientRect().width,
  //height = d3.select('#map').node().getBoundingClientRect().height;

  var width = d3.select('#map').node().getBoundingClientRect().width,
  height = d3.select('#map').node().getBoundingClientRect().height;

  console.log(width);
  console.log(height);

  var center = [width / 2, height / 2];

  var projection = d3.geoMercator()
  .center([0, 10]);

  var bigsvg = d3.select("#bigsvg")
  .append("map")
  .attr("width", width)
  .attr("height", height);

  var svg = d3.select("#map")
  .append("svg")
  .attr("width", width)
  .attr("height", height);

  var path = d3.geoPath()
  .projection(projection);

  var g = svg.append("g");

  var sizescale = d3.scaleSqrt().domain([0,8000000]).range([1,100]);

  var color = d3.scaleOrdinal().domain(["Vulnerable", "Definitely endangered", "Severely endangered", "Critically endangered", "Extinct"])
  .range(["#8ad08a", "#c5b7d9", "#eaf202", "#f2020e","#000000"]);

  console.log(color);

  d3.json("world-110m2.json").then(function(topology) {

    g.selectAll("path")
    .data(topojson.feature(topology, topology.objects.countries)
    .features)
    .enter().append("path")
    .attr("d", path);

  });

  d3.csv("Extinct-Languages-Processed-LineBreaks.csv").then(function(cities) {
    cities.sort((a, b) => b.NumSpeakers - a.NumSpeakers);

    const group = svg.append('g').attr('id', 'bubbles');
    const bubbles = group.selectAll('circle')
    .data(cities)
    .enter()
    .append('circle');

    bubbles
    .attr("cx", function(d) {
      d.IsUnderMax = (d.IsUnderMax =="true");
      return projection([parseFloat(d.Longitude), parseFloat(d.Latitude)])[0];})
    .attr("cy", function(d) {
      return projection([parseFloat(d.Longitude), parseFloat(d.Latitude)])[1];})
    .attr("r", d=>sizescale(parseInt(d.NumSpeakers)))
    .style("fill", d=>color(d.DegreeEndangerment))
    .style("stroke", "black")
    .style("stroke-width", 0.1);

    circles = d3.select("g#bubbles").selectAll("circle");
    circles.on("mouseover.highlight", function(d) {
      d3.select(this)
      .raise() // bring to front
      .style("stroke", "red")
      .style("stroke-width", 2);
      console.log("MOUSEOVER");

      // show what we interacted with
      //d3.select(status).text("highlight: dog");
    });

    circles.on("mouseout.highlight", function(d) {
      d3.select(this).lower().style("stroke", null);
      //d3.select(status).text("highlight: none");
    });


      });



      var zoom = d3.zoom()
      .scaleExtent([1, 8])
      .on('zoom', function() {
        g.selectAll('path').attr('transform', d3.event.transform);
        svg.selectAll('circle').attr('transform', d3.event.transform);
      });

      svg.call(zoom);

      d3.select('#zoom-in').on('click', function () {
        svg.transition().call(zoom.scaleBy, 2)
      });

      d3.select('#zoom-out').on('click', function () {
        svg.transition().call(zoom.scaleBy, 0.5)
      });

      d3.select('#reset').on('click', function () {
        svg.transition().duration(750).call(
          zoom.transform,
          d3.zoomIdentity,
          d3.zoomTransform(svg.node()).invert([width / 2, height / 2])
        )
      });

      d3.select("#goal").on("input", function() {
        goal = +this.value;
        d3.select('#goal-value').text(goal);

        svg.selectAll("circle").each(function(d) {
          //if checked, consider
          //this.style.opacity = d.NumSpeakers < goal ? 1 : 0;
          if (d.IsChecked) {
            this.style.opacity = d.NumSpeakers < goal ? 1 : 0;
          }
          d.IsUnderMax = d.NumSpeakers < goal ? 1 : 0;
        });
      });

      // When a button change, I run the update function
      d3.selectAll(".checkbox").on("change",update);
      // And I initialize it at the beginning
      update();

      function update() {

        //console.log(circles);
        // For each check box:
        d3.selectAll(".checkbox").each(function(d){
          cb = d3.select(this);
          grp = cb.property("value");


          // p sure this does 1 row at a time
          //console.log(cb.property("value"), cb.property("checked"), grp)
          //circles = d3.select("g#bubbles").selectAll("circle");

          // If the box is check, I show the group
          if(cb.property("checked")){
            console.log("BOX CHEKCED")
            svg.selectAll("circle").each(function(e) {
              e.IsChecked = true;
              if (e.IsUnderMax && e.DegreeEndangerment == grp) {
                this.style.opacity = 1;
                console.log(e.DegreeEndangerment);
                console.log(color(e.DegreeEndangerment));
              }

              //this.style.opacity = e.DegreeEndangerment == grp ? 1 : 0;
            });

            //console.log(svg.selectAll('circles'));
            //svg.selectAll(".checkbox"+grp).transition().duration(1000).style("opacity", 1)//.attr("r", function(d){ return size(d.size) })
            //svg.selectAll("circle").transition().duration(1000).style("opacity", 1);
            //circles.filter(e=>d.DegreeEndangerment == cb.property("value")).style("opacity", 1)
            // Otherwise I hide it
          }else{ // if unchecked
console.log("BOX UNCHECKED")
            svg.selectAll("circle").each(function(e) {

              e.IsChecked=false;
              if (e.IsUnderMax && e.DegreeEndangerment == grp) {
                this.style.opacity = 0;
                console.log(e.DegreeEndangerment);
                console.log(color(e.DegreeEndangerment));
              }
            });
            //circles.filter(e=>d.DegreeEndangerment == cb.property("value")).style("opacity", 0)
          }
        })
      }

      const legendWidth = 200;
const legendHeight = 20;

// place legend into its own group
const group = svg.append('g').attr('id', 'circle-legend');

// position legend
//group.attr('transform', translate(width - margin.right - legendWidth, margin.top + 75))
group.attr('transform', translate(650, 400))

// https://d3-legend.susielu.com/#size-linear
const legendSize = d3.legendSize()
.scale(sizescale)
.shape('circle')
.cells([0,100,1000,10000,100000,1000000])
.ascending(false)
.shapePadding(30)
.labelOffset(10)
.labelFormat("d")
.labelAlign("middle")
.title('Number of Speakers')
.orient('horizontal');

group.call(legendSize);

// fix the title spacing
group.select('text.legendTitle').attr('dy', -8);

/*
* returns a translate string for the transform attribute
*/
function translate(x, y) {
  return 'translate(' + String(x) + ',' + String(y) + ')';
}


        </script>
        </body>

        </html>
